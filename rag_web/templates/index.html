{% extends "base.html" %}
{% block title %}RAG Chatbot{% endblock %}

{% block content %}
<section class="grid">
  <div class="col chat-col card">
    <div class="neural-stage">
      <div id="neural-network" class="neural-network">
        <svg viewBox="0 0 280 180" preserveAspectRatio="xMidYMid meet">
          <!-- Connections (drawn first so nodes appear on top) -->
          <g class="connections">
            <!-- Layer 1 to 2 -->
            <path class="conn" d="M30,30 Q80,40 70,30"/>
            <path class="conn" d="M30,30 Q80,60 70,60"/>
            <path class="conn" d="M30,30 Q80,90 70,90"/>
            <path class="conn" d="M30,30 Q80,120 70,120"/>
            <path class="conn" d="M30,60 Q80,30 70,30"/>
            <path class="conn" d="M30,60 Q80,60 70,60"/>
            <path class="conn" d="M30,60 Q80,90 70,90"/>
            <path class="conn" d="M30,60 Q80,120 70,120"/>
            <path class="conn" d="M30,90 Q80,30 70,30"/>
            <path class="conn" d="M30,90 Q80,60 70,60"/>
            <path class="conn" d="M30,90 Q80,90 70,90"/>
            <path class="conn" d="M30,90 Q80,120 70,120"/>
            <path class="conn" d="M30,120 Q80,30 70,30"/>
            <path class="conn" d="M30,120 Q80,60 70,60"/>
            <path class="conn" d="M30,120 Q80,90 70,90"/>
            <path class="conn" d="M30,120 Q80,120 70,120"/>
            <path class="conn" d="M30,150 Q80,90 70,90"/>
            <path class="conn" d="M30,150 Q80,120 70,120"/>
            
            <!-- Layer 2 to 3 -->
            <path class="conn" d="M70,30 Q110,45 110,45"/>
            <path class="conn" d="M70,30 Q110,75 110,75"/>
            <path class="conn" d="M70,30 Q110,105 110,105"/>
            <path class="conn" d="M70,30 Q110,135 110,135"/>
            <path class="conn" d="M70,60 Q110,45 110,45"/>
            <path class="conn" d="M70,60 Q110,75 110,75"/>
            <path class="conn" d="M70,60 Q110,105 110,105"/>
            <path class="conn" d="M70,60 Q110,135 110,135"/>
            <path class="conn" d="M70,90 Q110,45 110,45"/>
            <path class="conn" d="M70,90 Q110,75 110,75"/>
            <path class="conn" d="M70,90 Q110,105 110,105"/>
            <path class="conn" d="M70,90 Q110,135 110,135"/>
            <path class="conn" d="M70,120 Q110,45 110,45"/>
            <path class="conn" d="M70,120 Q110,75 110,75"/>
            <path class="conn" d="M70,120 Q110,105 110,105"/>
            <path class="conn" d="M70,120 Q110,135 110,135"/>
            
            <!-- Layer 3 to 4 -->
            <path class="conn" d="M110,45 Q150,35 150,35"/>
            <path class="conn" d="M110,45 Q150,65 150,65"/>
            <path class="conn" d="M110,45 Q150,95 150,95"/>
            <path class="conn" d="M110,45 Q150,125 150,125"/>
            <path class="conn" d="M110,45 Q150,155 150,155"/>
            <path class="conn" d="M110,75 Q150,35 150,35"/>
            <path class="conn" d="M110,75 Q150,65 150,65"/>
            <path class="conn" d="M110,75 Q150,95 150,95"/>
            <path class="conn" d="M110,75 Q150,125 150,125"/>
            <path class="conn" d="M110,75 Q150,155 150,155"/>
            <path class="conn" d="M110,105 Q150,35 150,35"/>
            <path class="conn" d="M110,105 Q150,65 150,65"/>
            <path class="conn" d="M110,105 Q150,95 150,95"/>
            <path class="conn" d="M110,105 Q150,125 150,125"/>
            <path class="conn" d="M110,105 Q150,155 150,155"/>
            <path class="conn" d="M110,135 Q150,35 150,35"/>
            <path class="conn" d="M110,135 Q150,65 150,65"/>
            <path class="conn" d="M110,135 Q150,95 150,95"/>
            <path class="conn" d="M110,135 Q150,125 150,125"/>
            <path class="conn" d="M110,135 Q150,155 150,155"/>
            
            <!-- Layer 4 to 5 -->
            <path class="conn" d="M150,35 Q190,50 190,50"/>
            <path class="conn" d="M150,35 Q190,90 190,90"/>
            <path class="conn" d="M150,35 Q190,130 190,130"/>
            <path class="conn" d="M150,65 Q190,50 190,50"/>
            <path class="conn" d="M150,65 Q190,90 190,90"/>
            <path class="conn" d="M150,65 Q190,130 190,130"/>
            <path class="conn" d="M150,95 Q190,50 190,50"/>
            <path class="conn" d="M150,95 Q190,90 190,90"/>
            <path class="conn" d="M150,95 Q190,130 190,130"/>
            <path class="conn" d="M150,125 Q190,50 190,50"/>
            <path class="conn" d="M150,125 Q190,90 190,90"/>
            <path class="conn" d="M150,125 Q190,130 190,130"/>
            <path class="conn" d="M150,155 Q190,90 190,90"/>
            <path class="conn" d="M150,155 Q190,130 190,130"/>
            
            <!-- Layer 5 to 6 -->
            <path class="conn" d="M190,50 Q230,60 230,60"/>
            <path class="conn" d="M190,50 Q230,120 230,120"/>
            <path class="conn" d="M190,90 Q230,60 230,60"/>
            <path class="conn" d="M190,90 Q230,120 230,120"/>
            <path class="conn" d="M190,130 Q230,60 230,60"/>
            <path class="conn" d="M190,130 Q230,120 230,120"/>
            
            <!-- Layer 6 to output -->
            <path class="conn" d="M230,60 Q260,90 260,90"/>
            <path class="conn" d="M230,120 Q260,90 260,90"/>
          </g>
          
          <!-- Layer 1: Input (5 nodes) -->
          <circle class="node" cx="30" cy="30" r="8"/>
          <circle class="node" cx="30" cy="60" r="8"/>
          <circle class="node" cx="30" cy="90" r="8"/>
          <circle class="node" cx="30" cy="120" r="8"/>
          <circle class="node" cx="30" cy="150" r="8"/>
          
          <!-- Layer 2: Hidden (4 nodes) -->
          <circle class="node" cx="70" cy="30" r="7"/>
          <circle class="node" cx="70" cy="60" r="7"/>
          <circle class="node" cx="70" cy="90" r="7"/>
          <circle class="node" cx="70" cy="120" r="7"/>
          
          <!-- Layer 3: Hidden (4 nodes) -->
          <circle class="node" cx="110" cy="45" r="7"/>
          <circle class="node" cx="110" cy="75" r="7"/>
          <circle class="node" cx="110" cy="105" r="7"/>
          <circle class="node" cx="110" cy="135" r="7"/>
          
          <!-- Layer 4: Hidden (5 nodes) -->
          <circle class="node" cx="150" cy="35" r="7"/>
          <circle class="node" cx="150" cy="65" r="7"/>
          <circle class="node" cx="150" cy="95" r="7"/>
          <circle class="node" cx="150" cy="125" r="7"/>
          <circle class="node" cx="150" cy="155" r="7"/>
          
          <!-- Layer 5: Hidden (3 nodes) -->
          <circle class="node" cx="190" cy="50" r="7"/>
          <circle class="node" cx="190" cy="90" r="7"/>
          <circle class="node" cx="190" cy="130" r="7"/>
          
          <!-- Layer 6: Hidden (2 nodes) -->
          <circle class="node" cx="230" cy="60" r="7"/>
          <circle class="node" cx="230" cy="120" r="7"/>
          
          <!-- Output node -->
          <circle class="node" cx="260" cy="90" r="9" style="stroke: #22d3ee;"/>
          
          <!-- Signal particles (16 total for more activity) -->
          <circle class="signal" r="3" style="offset-path: path('M30,30 Q80,40 70,30 Q110,45 110,45 Q150,65 150,65 Q190,90 190,90 Q230,120 230,120 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,60 Q80,60 70,60 Q110,75 110,75 Q150,95 150,95 Q190,90 190,90 Q230,60 230,60 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,90 Q80,90 70,90 Q110,105 110,105 Q150,125 150,125 Q190,130 190,130 Q230,120 230,120 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,120 Q80,120 70,120 Q110,135 110,135 Q150,155 150,155 Q190,130 190,130 Q230,60 230,60 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,150 Q80,120 70,120 Q110,105 110,105 Q150,95 150,95 Q190,50 190,50 Q230,60 230,60 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,30 Q80,60 70,60 Q110,45 110,45 Q150,35 150,35 Q190,50 190,50 Q230,120 230,120 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,60 Q80,90 70,90 Q110,75 110,75 Q150,65 150,65 Q190,90 190,90 Q230,60 230,60 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,90 Q80,60 70,60 Q110,45 110,45 Q150,35 150,35 Q190,50 190,50 Q230,60 230,60 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,120 Q80,90 70,90 Q110,105 110,105 Q150,95 150,95 Q190,90 190,90 Q230,120 230,120 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,150 Q80,90 70,90 Q110,75 110,75 Q150,65 150,65 Q190,50 190,50 Q230,60 230,60 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,30 Q80,120 70,120 Q110,135 110,135 Q150,125 150,125 Q190,130 190,130 Q230,120 230,120 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,60 Q80,30 70,30 Q110,45 110,45 Q150,65 150,65 Q190,90 190,90 Q230,60 230,60 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,90 Q80,120 70,120 Q110,105 110,105 Q150,125 150,125 Q190,90 190,90 Q230,120 230,120 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,120 Q80,60 70,60 Q110,75 110,75 Q150,95 150,95 Q190,130 190,130 Q230,60 230,60 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,150 Q80,120 70,120 Q110,135 110,135 Q150,95 150,95 Q190,50 190,50 Q230,120 230,120 Q260,90 260,90');"/>
          <circle class="signal" r="3" style="offset-path: path('M30,30 Q80,90 70,90 Q110,75 110,75 Q150,95 150,95 Q190,130 190,130 Q230,60 230,60 Q260,90 260,90');"/>
        </svg>
      </div>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <form id="chat-form" class="chat-form" autocomplete="off">
      <input id="chat-input" type="text" placeholder="Ask me anything from your docs‚Ä¶" required />
      <div class="controls">
        <label class="k-label">
          Top-K
          <input id="topk" type="number" min="1" max="10" value="4">
        </label>
        <button id="send-btn" type="submit">Send</button>
      </div>
    </form>
  </div>

  <div class="col docs-col">
    <section class="card">
      <h2>Documents</h2>
      <p class="muted">Upload documents to sync with AWS Bedrock Knowledge Base.</p>
      <p class="muted" style="font-size: 0.75rem;">Supported: <code>.txt</code>, <code>.pdf</code>, <code>.md</code>, <code>.csv</code>, <code>.html</code>, <code>.docx</code></p>
      <form id="upload-form" enctype="multipart/form-data" class="upload-form">
        <input type="file" name="files" id="files" accept=".txt,.pdf,.md,.csv,.html,.docx,.doc" multiple>
        <button type="submit" id="upload-btn" class="secondary">Upload & Sync</button>
        <button type="button" id="sync-btn" class="ghost">Manual Sync</button>
      </form>
      
      <!-- Upload Progress -->
      <div id="upload-progress" class="progress-container hidden">
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
        <div id="progress-text" class="progress-text">Uploading...</div>
      </div>
      
      <!-- Uploaded Files List -->
      <div id="uploaded-files" class="uploaded-files-list hidden"></div>
      
      <!-- Status Display -->
      <div id="status" class="status-box">
        <div id="status-icon" class="status-icon">‚è≥</div>
        <div id="status-text" class="status-text">Loading status‚Ä¶</div>
      </div>
    </section>

    <section class="card">
      <h2>Last Context</h2>
      <details id="ctx-details" open>
        <summary>Show/Hide</summary>
        <ol id="context-list"></ol>
      </details>
    </section>
  </div>
</section>

<script>
const msgs  = document.getElementById("messages");
const neuralNetwork = document.getElementById("neural-network");
const input = document.getElementById("chat-input");
const form  = document.getElementById("chat-form");
const sendBtn = document.getElementById("send-btn");
const topKEl  = document.getElementById("topk");
const ctxList = document.getElementById("context-list");
const statusEl = document.getElementById("status");
const statusIcon = document.getElementById("status-icon");
const statusText = document.getElementById("status-text");
const uploadProgress = document.getElementById("upload-progress");
const progressFill = document.getElementById("progress-fill");
const progressText = document.getElementById("progress-text");
const uploadBtn = document.getElementById("upload-btn");
const syncBtn = document.getElementById("sync-btn");
const uploadedFilesEl = document.getElementById("uploaded-files");

let ingestionPollInterval = null;

// Bubble helpers
function addBubble(text, who="user") {
  const wrap = document.createElement("div");
  wrap.className = `bubble ${who}`;
  wrap.textContent = text;
  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
}

function setThinking(on) {
  if (on) {
    neuralNetwork.classList.add("thinking");
  } else {
    neuralNetwork.classList.remove("thinking");
  }
  sendBtn.disabled = on;
  input.disabled = on;
}

// Status helpers
function setStatus(icon, text, statusClass = "") {
  statusIcon.textContent = icon;
  statusText.textContent = text;
  statusEl.className = "status-box";
  if (statusClass) {
    statusEl.classList.add(statusClass);
  }
}

function flashStatus() {
  statusEl.classList.add("status-flash");
  setTimeout(() => statusEl.classList.remove("status-flash"), 1500);
}

// Progress helpers
function showProgress(show) {
  if (show) {
    uploadProgress.classList.remove("hidden");
  } else {
    uploadProgress.classList.add("hidden");
  }
}

function updateProgress(percent, text) {
  progressFill.style.width = percent + "%";
  progressText.textContent = text;
}

// Show uploaded files
function showUploadedFiles(files) {
  if (files.length === 0) {
    uploadedFilesEl.classList.add("hidden");
    return;
  }
  uploadedFilesEl.classList.remove("hidden");
  uploadedFilesEl.innerHTML = "<strong>Uploaded:</strong> " + 
    files.map(f => `<span class="file-tag">${f}</span>`).join(" ");
}

// Health check
async function checkHealth() {
  try {
    const res = await fetch("/health");
    const data = await res.json();
    if (data.status === "healthy") {
      setStatus("‚úÖ", `Ready (${data.document_count} docs in S3)`, "status-success");
    } else {
      setStatus("‚ö†Ô∏è", data.message || "Service issue", "status-warning");
    }
  } catch (e) {
    setStatus("‚ùå", "Cannot connect to backend", "status-error");
  }
}

// Poll ingestion status
async function pollIngestionStatus(jobId) {
  setStatus("üîÑ", "Syncing with Knowledge Base...", "status-syncing");
  
  ingestionPollInterval = setInterval(async () => {
    try {
      const res = await fetch(`/ingestion-status/${jobId}`);
      const data = await res.json();
      
      if (data.status === "COMPLETE") {
        clearInterval(ingestionPollInterval);
        setStatus("‚úÖ", "Sync complete! Documents indexed.", "status-success");
        flashStatus();
        checkHealth();
      } else if (data.status === "FAILED") {
        clearInterval(ingestionPollInterval);
        setStatus("‚ùå", "Sync failed: " + (data.failure_reasons || "Unknown error"), "status-error");
      } else {
        setStatus("üîÑ", `Syncing: ${data.status}...`, "status-syncing");
      }
    } catch (e) {
      clearInterval(ingestionPollInterval);
      setStatus("‚ö†Ô∏è", "Could not check sync status", "status-warning");
    }
  }, 3000);
}

// Chat
form.addEventListener("submit", async e => {
  e.preventDefault();
  const q = input.value.trim();
  if (!q) return;
  addBubble(q, "user");
  input.value = "";
  setThinking(true);

  try {
    const res = await fetch("/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: q, top_k: parseInt(topKEl.value) || 4 })
    });
    const data = await res.json();
    addBubble(data.answer || data.error, "bot");
    
    // Update context
    ctxList.innerHTML = "";
    (data.context || []).forEach((c, i) => {
      const li = document.createElement("li");
      const truncated = c.length > 150 ? c.substring(0, 150) + "..." : c;
      li.textContent = truncated;
      li.dataset.full = c;
      li.dataset.truncated = truncated;
      li.addEventListener("click", () => {
        if (li.classList.contains("expanded")) {
          li.textContent = li.dataset.truncated;
          li.classList.remove("expanded");
        } else {
          li.textContent = li.dataset.full;
          li.classList.add("expanded");
        }
      });
      ctxList.appendChild(li);
    });
  } catch (err) {
    addBubble("Error: " + err.message, "bot");
  }
  setThinking(false);
});

// Upload
document.getElementById("upload-form").addEventListener("submit", async e => {
  e.preventDefault();
  const filesInput = document.getElementById("files");
  if (!filesInput.files.length) return;
  
  const fileNames = Array.from(filesInput.files).map(f => f.name);
  
  const fd = new FormData();
  for (const f of filesInput.files) fd.append("files", f);
  
  showProgress(true);
  updateProgress(0, "Uploading files...");
  uploadBtn.disabled = true;
  syncBtn.disabled = true;
  
  try {
    // Simulate upload progress
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += 10;
      if (progress <= 90) {
        updateProgress(progress, `Uploading... ${progress}%`);
      }
    }, 200);
    
    const res = await fetch("/upload", { method: "POST", body: fd });
    
    clearInterval(progressInterval);
    updateProgress(100, "Upload complete!");
    
    const data = await res.json();
    
    if (data.ingestion_job_id) {
      showUploadedFiles(fileNames);
      setTimeout(() => showProgress(false), 1000);
      pollIngestionStatus(data.ingestion_job_id);
    } else {
      setStatus("‚ö†Ô∏è", data.message || "Upload completed", "status-warning");
      showProgress(false);
    }
  } catch (err) {
    setStatus("‚ùå", "Upload failed: " + err.message, "status-error");
    showProgress(false);
  }
  
  uploadBtn.disabled = false;
  syncBtn.disabled = false;
  filesInput.value = "";
});

// Manual sync
syncBtn.addEventListener("click", async () => {
  syncBtn.disabled = true;
  uploadBtn.disabled = true;
  setStatus("üîÑ", "Starting manual sync...", "status-syncing");
  
  try {
    const res = await fetch("/sync", { method: "POST" });
    const data = await res.json();
    
    if (data.ingestion_job_id) {
      pollIngestionStatus(data.ingestion_job_id);
    } else {
      setStatus("‚ö†Ô∏è", data.message || "Sync initiated", "status-warning");
    }
  } catch (err) {
    setStatus("‚ùå", "Sync failed: " + err.message, "status-error");
  }
  
  syncBtn.disabled = false;
  uploadBtn.disabled = false;
});

// Initial health check
checkHealth();
</script>
{% endblock %}
